generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ────────────────────────────────────────────────────────────────────

enum AuthProvider {
  LOCAL
  GOOGLE
}

enum UserRole {
  SUPER_ADMIN
  HR_ADMIN
  HR_MANAGER
}

enum JobOpeningStatus {
  OPEN
  CLOSED
  ON_HOLD
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  INTERN
  CONTRACT
}

enum EmployeeStatus {
  ACTIVE
  RESIGNED
  TERMINATED
  ON_LEAVE
}

enum ApplicationStatus {
  APPLIED
  SHORTLISTED
  INTERVIEWING
  OFFERED
  HIRED
  REJECTED
  WITHDRAWN
}

enum InterviewStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum GoalStatus {
  ON_TRACK
  AT_RISK
  DELAYED
  COMPLETED
  CANCELLED
}

enum WorkArrangement {
  REMOTE
  ON_SITE
  HYBRID
}

enum CandidateSource {
  LINKEDIN
  REFERRAL
  JOB_BOARD
  COMPANY_WEBSITE
  AGENCY
  OTHER
}

// ─── Auth ─────────────────────────────────────────────────────────────────────

model User {
  id            String       @id @default(cuid())
  email         String       @unique
  passwordHash  String?
  provider      AuthProvider @default(LOCAL)
  googleId      String?      @unique
  emailVerified Boolean      @default(false)
  role          UserRole     @default(HR_MANAGER)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  refreshTokens     RefreshToken[]
  employee          Employee?
  conductedInterviews Interview[]   @relation("Interviewer")
  managedOpenings   JobOpening[]   @relation("HiringManager")

  @@index([provider])
  @@index([createdAt])
}

model RefreshToken {
  id                String    @id @default(cuid())
  userId            String
  jtiHash           String    @unique
  familyId          String
  replacedByJtiHash String?
  revokedAt         DateTime?
  expiresAt         DateTime
  userAgent         String?
  ipAddress         String?
  createdAt         DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt])
  @@index([familyId])
  @@index([expiresAt])
}

// ─── Organization ─────────────────────────────────────────────────────────────

model Organization {
  id            String    @id @default(cuid())
  name          String
  domain        String?   @unique
  logoUrl       String?
  description   String?
  establishedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  departments  Department[]
  employees    Employee[]
  jobOpenings  JobOpening[]

  @@index([domain])
}

model Department {
  id             String   @id @default(cuid())
  name           String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  positions    JobPosition[]
  employees    Employee[]
  jobOpenings  JobOpening[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model JobPosition {
  id           String  @id @default(cuid())
  title        String
  departmentId String
  level        String? // e.g. L1, L2, Senior, Staff
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  employees  Employee[]

  @@index([departmentId])
}

// ─── Recruiting ───────────────────────────────────────────────────────────────

model JobOpening {
  id              String           @id @default(cuid())
  title           String
  description     String
  organizationId  String
  departmentId    String
  hiringManagerId String
  status          JobOpeningStatus @default(OPEN)
  vacancies       Int              @default(1)
  salaryMin       Float?
  salaryMax       Float?
  currency        String?          @default("USD")
  employmentType  EmploymentType   @default(FULL_TIME)
  workArrangement WorkArrangement  @default(ON_SITE)
  closedAt        DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department     Department    @relation(fields: [departmentId], references: [id])
  hiringManager  User          @relation("HiringManager", fields: [hiringManagerId], references: [id])
  applications   Application[]

  @@index([organizationId, status])
  @@index([departmentId])
  @@index([hiringManagerId])
  @@index([status, createdAt])
}

model Candidate {
  id        String          @id @default(cuid())
  name      String
  email     String          @unique
  phone     String?
  resumeUrl String?
  source    CandidateSource @default(OTHER)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  applications Application[]

  @@index([email])
  @@index([createdAt])
}

model Application {
  id          String            @id @default(cuid())
  candidateId String
  jobOpeningId String
  status      ApplicationStatus @default(APPLIED)
  coverLetter String?
  appliedAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  candidate  Candidate   @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  jobOpening JobOpening  @relation(fields: [jobOpeningId], references: [id], onDelete: Cascade)
  interviews Interview[]

  @@unique([candidateId, jobOpeningId])
  @@index([candidateId])
  @@index([jobOpeningId])
  @@index([status])
}

model Interview {
  id            String          @id @default(cuid())
  applicationId String
  interviewerId String
  scheduledAt   DateTime
  durationMins  Int             @default(60)
  location      String?         // URL for virtual, room for on-site
  feedback      String?
  rating        Int?            // 1–5
  status        InterviewStatus @default(SCHEDULED)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  interviewer User        @relation("Interviewer", fields: [interviewerId], references: [id])

  @@index([applicationId])
  @@index([interviewerId])
  @@index([scheduledAt])
}

// ─── HR / Employee ────────────────────────────────────────────────────────────

model Employee {
  id             String         @id @default(cuid())
  userId         String         @unique
  organizationId String
  departmentId   String
  positionId     String
  employeeCode   String?        @unique // e.g. EMP-0042
  joiningDate    DateTime
  exitDate       DateTime?
  employmentType EmploymentType @default(FULL_TIME)
  status         EmployeeStatus @default(ACTIVE)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  user          User               @relation(fields: [userId], references: [id], onDelete: Restrict)
  organization  Organization       @relation(fields: [organizationId], references: [id])
  department    Department         @relation(fields: [departmentId], references: [id])
  position      JobPosition        @relation(fields: [positionId], references: [id])
  leaveRequests LeaveRequest[]
  compensations Compensation[]
  goals         Goal[]
  reviews       PerformanceReview[] @relation("ReviewSubject")
  conductedReviews PerformanceReview[] @relation("Reviewer")

  @@index([organizationId, status])
  @@index([departmentId])
  @@index([userId])
}

model LeaveRequest {
  id         String      @id @default(cuid())
  employeeId String
  startDate  DateTime
  endDate    DateTime
  leaveType  String      // ANNUAL, SICK, MATERNITY, PATERNITY, UNPAID
  reason     String?
  status     LeaveStatus @default(PENDING)
  reviewedBy String?
  reviewedAt DateTime?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId, status])
  @@index([startDate, endDate])
}

model Compensation {
  id            String   @id @default(cuid())
  employeeId    String
  baseSalary    Float
  bonus         Float?   @default(0)
  currency      String   @default("USD")
  effectiveFrom DateTime
  effectiveTo   DateTime?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId, effectiveFrom])
}

model Goal {
  id          String     @id @default(cuid())
  employeeId  String
  title       String
  description String?
  dueDate     DateTime
  status      GoalStatus @default(ON_TRACK)
  progress    Int        @default(0) // 0–100 percent
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId, status])
  @@index([dueDate])
}

model PerformanceReview {
  id             String   @id @default(cuid())
  employeeId     String
  reviewerId     String
  reviewPeriod   String   // e.g. "2024-Q4" or "2024-H1"
  rating         Int      // 1–5
  comments       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  employee Employee @relation("ReviewSubject", fields: [employeeId], references: [id], onDelete: Cascade)
  reviewer Employee @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Restrict)

  @@unique([employeeId, reviewerId, reviewPeriod])
  @@index([employeeId])
  @@index([reviewerId])
  @@index([reviewPeriod])
}