generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

enum UserRole {
  SUPER_ADMIN
  HR_ADMIN
  HR_MANAGER
}

enum EmployeeStatus {
  ACTIVE
  RESIGNED
  TERMINATED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum GoalType {
  WEEKLY
  MONTHLY
}

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PayrollStatus {
  DRAFT
  PROCESSED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LEAVE
  HALF_DAY
}

enum AuditAction {
  EMPLOYEE_STATUS_CHANGED
  EMPLOYEE_SOFT_DELETED
  GOAL_CREATED
  GOAL_UPDATED
  REVIEW_CREATED
  LEAVE_APPROVED
  LEAVE_REJECTED
  COMPENSATION_UPDATED
  PAYROLL_PROCESSED
  ATTENDANCE_UPDATED
}

model User {
  id            String       @id @default(cuid())
  email         String       @unique
  passwordHash  String?
  provider      AuthProvider @default(LOCAL)
  googleId      String?      @unique
  emailVerified Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  role UserRole @default(HR_MANAGER)

  refreshTokens RefreshToken[]
  employee      Employee?

  @@index([provider])
  @@index([createdAt])
}

model RefreshToken {
  id                String    @id @default(cuid())
  userId            String
  jtiHash           String    @unique
  familyId          String
  replacedByJtiHash String?
  revokedAt         DateTime?
  expiresAt         DateTime
  userAgent         String?
  ipAddress         String?
  createdAt         DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt])
  @@index([familyId])
  @@index([expiresAt])
}

model Organization {
  id            String    @id
  name          String
  domain        String?
  orgLogo       String?
  description   String?
  establishedAt DateTime?
  createdAt     DateTime

  employees Employee[]
}

model Department {
  id             String @id
  name           String
  organizationId String

  employees Employee[]
}

model JobPosition {
  id           String  @id
  title        String
  departmentId String
  level        String? // L1, L2, Senior, etc.

  employees Employee[]
}

model JobOpening {
  id              String   @id
  title           String
  description     String
  departmentId    String
  hiringManagerId String
  status          String // OPEN, CLOSED, ON_HOLD
  createdAt       DateTime
  vacancies       Int
  compensation    String? // Salary range or details
  duration        String? // Full-time, Part-time, Contract
  jobType         String? // Remote, On-site, Hybrid
}

model Candidate {
  id        String   @id
  name      String
  email     String
  phone     String?
  resumeUrl String?
  source    String? // LinkedIn, Referral, etc.
  createdAt DateTime
}

model Application {
  id          String   @id
  candidateId String
  jobId       String
  status      String // APPLIED, SHORTLISTED, INTERVIEW, OFFERED, REJECTED
  appliedAt   DateTime
}

model Interview {
  id            String   @id
  applicationId String
  interviewer   String
  scheduledAt   DateTime
  feedback      String?
  rating        Int?
  status        String // SCHEDULED, COMPLETED
}

model Employee {
  id             String         @id @default(cuid())
  userId         String         @unique
  organizationId String
  departmentId   String
  positionId     String
  firstName      String         @default("First")
  lastName       String         @default("Last")
  email          String         @unique
  phone          String?
  joiningDate    DateTime
  employmentType EmploymentType @default(FULL_TIME)
  status         EmployeeStatus @default(ACTIVE)
  deletedAt      DateTime?      // Soft delete
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  department   Department   @relation(fields: [departmentId], references: [id])
  position     JobPosition  @relation(fields: [positionId], references: [id])

  goals         Goal[]
  reviews       PerformanceReview[] @relation("ReviewSubject")
  reviewsGiven  PerformanceReview[] @relation("Reviewer")
  leaveRequests LeaveRequest[]
  compensations Compensation[]
  payrolls      Payroll[]
  attendances   Attendance[]

  // Indexes
  @@index([organizationId, status, deletedAt])
  @@index([departmentId])
  @@index([email])
  @@index([organizationId, departmentId, status])
}

model Goal {
  id          String     @id @default(cuid())
  employeeId  String
  title       String
  description String?
  type        GoalType
  dueDate     DateTime
  status      GoalStatus @default(NOT_STARTED)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, type, status])
}

model LeaveRequest {
  id         String      @id @default(cuid())
  employeeId String
  startDate  DateTime
  endDate    DateTime
  leaveType  String      @default("ANNUAL") // ANNUAL, SICK, PERSONAL, UNPAID
  reason     String?
  status     LeaveStatus @default(PENDING)
  reviewedBy String?     // userId of HR Admin who approved/rejected
  reviewedAt DateTime?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, status])
  @@index([status]) // For dashboard pending count
}

model Compensation {
  id            String   @id @default(cuid())
  employeeId    String
  baseSalary    Float
  bonus         Float?
  currency      String
  effectiveFrom DateTime

  employee Employee @relation(fields: [employeeId], references: [id])
}

model PerformanceReview {
  id           String   @id @default(cuid())
  employeeId   String
  reviewerId   String
  reviewPeriod String
  rating       Int      // 1-5
  comments     String?
  createdAt    DateTime @default(now())

  employee Employee @relation("ReviewSubject", fields: [employeeId], references: [id])
  reviewer Employee @relation("Reviewer", fields: [reviewerId], references: [id])

  @@index([employeeId, createdAt])
}

model Payroll {
  id                 String        @id @default(cuid())
  employeeId         String
  month              Int           // 1-12
  year               Int
  grossPay           Float
  basicSalary        Float
  allowances         Float         @default(0)
  deductionTax       Float         @default(0)
  deductionPF        Float         @default(0) // Provident Fund
  deductionInsurance Float         @default(0)
  deductionOther     Float         @default(0)
  totalDeductions    Float
  netPay             Float
  currency           String        @default("INR")
  status             PayrollStatus @default(DRAFT)
  processedBy        String?       // userId of HR Admin who processed
  processedAt        DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, month, year]) // One payroll per employee per month
  @@index([employeeId, year, month])
  @@index([status])
}

model Attendance {
  id         String           @id @default(cuid())
  employeeId String
  date       DateTime         @db.Date
  status     AttendanceStatus
  checkIn    DateTime?
  checkOut   DateTime?
  notes      String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date]) // One record per employee per day
  @@index([employeeId, date])
  @@index([date, status]) // For daily compliance queries
}

model AuditLog {
  id         String      @id @default(cuid())
  action     AuditAction
  entityType String      // 'Employee', 'Goal', 'LeaveRequest', etc.
  entityId   String
  actorId    String      // userId of the person who performed the action
  oldValue   Json?       // Previous state (for updates)
  newValue   Json?       // New state
  metadata   Json?       // Additional context (IP address, user agent)
  createdAt  DateTime    @default(now())

  @@index([entityType, entityId])
  @@index([actorId, createdAt])
  @@index([action, createdAt])
  @@index([createdAt]) // For time-range queries
}
